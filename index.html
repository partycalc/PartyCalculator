<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Party Calculator</title>
  <!-- Telegram WebApp (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω, –Ω–æ –Ω–µ –ª–æ–º–∞–µ—Ç —Ä–∞–±–æ—Ç—É –Ω–∞ GitHub Pages) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel –¥–ª—è inline JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#f8fafc;color:#111}
    #root{min-height:100vh}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const {useState, useEffect} = React;

    /* ================= ERRORS (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –±–µ–ª–æ–≥–æ —ç–∫—Ä–∞–Ω–∞) ================= */
    class ErrorBoundary extends React.Component {
      constructor(p){ super(p); this.state={hasError:false, err:''}; }
      static getDerivedStateFromError(error){ return {hasError:true, err:String(error)}; }
      componentDidCatch(error, info){ console.error('Runtime error:', error, info); }
      render(){
        if(this.state.hasError){
          return (
            <div className="min-h-screen grid place-items-center p-6 bg-red-50">
              <div className="max-w-xl w-full bg-white border-2 border-red-200 rounded-2xl p-6">
                <h2 className="text-xl font-bold text-red-600 mb-2">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞</h2>
                <p className="text-sm text-gray-600 mb-4 whitespace-pre-wrap">{this.state.err}</p>
                <button onClick={()=>location.reload()} className="bg-red-600 text-white px-4 py-2 rounded-lg">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
              </div>
            </div>
          );
        }
        return this.props.children;
      }
    }

    /* ================= –ò–∫–æ–Ω–∫–∏ (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ) ================= */
    const Icon = ({ d, ...props }) => (
      <svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        {typeof d === 'string' ? <path d={d} /> : d}
      </svg>
    );
    const Users = (p) => <Icon {...p} d={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />;
    const ShoppingCart = (p) => <Icon {...p} d={<><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></>} />;
    const Calculator = (p) => <Icon {...p} d={<><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/></>} />;
    const TrendingUp = (p) => <Icon {...p} d={<><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>} />;
    const Plus = (p) => <Icon {...p} d={<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>} />;
    const Edit2 = (p) => <Icon {...p} d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />;
    const Trash2 = (p) => <Icon {...p} d={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>} />;
    const Info = (p) => <Icon {...p} d={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>} />;
    const RotateCcw = (p) => <Icon {...p} d={<><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></>} />;
    const CheckCircle = (p) => <Icon {...p} d={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />;
    const Clock = (p) => <Icon {...p} d={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />;
    const XCircle = (p) => <Icon {...p} d={<><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></>} />;
    const Copy = (p) => <Icon {...p} d={<><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></>} />;

    /* ================= –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ================= */
    const PartyCalculator = () => {
      const [screen, setScreen] = useState('splash');
      const [activeTab, setActiveTab] = useState('participants');
      const [eventName, setEventName] = useState('');
      const [participants, setParticipants] = useState([]);
      const [purchases, setPurchases] = useState([]);
      const [consumption, setConsumption] = useState({}); // –∫–ª—é—á: groupKey (–ø–æ –ø—Ä–æ–¥—É–∫—Ç—É)
      const [newParticipant, setNewParticipant] = useState({ name: '' });
      const [editingParticipant, setEditingParticipant] = useState(null);
      const [editingPurchase, setEditingPurchase] = useState(null);
      const [newPurchase, setNewPurchase] = useState({ product: '', price: '', quantity: '', buyer: '' });
      const [settlements, setSettlements] = useState([]);
      const [paymentStatuses, setPaymentStatuses] = useState({});
      const [showResetConfirm, setShowResetConfirm] = useState(false);
      const [showHelp, setShowHelp] = useState(false);

      // Splash ‚Üí Main + Telegram init (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
      useEffect(() => {
        try { window.Telegram?.WebApp?.ready?.(); window.Telegram?.WebApp?.expand?.(); } catch(_){}
        if (screen === 'splash') {
          const t = setTimeout(() => setScreen('main'), 800);
          return () => clearTimeout(t);
        }
      }, [screen]);

      /* --------- –£—á–∞—Å—Ç–Ω–∏–∫–∏ --------- */
      const addParticipant = () => {
        const name = newParticipant.name.trim();
        if (!name) return;
        if (participants.find(p => p.name === name)) return;
        setParticipants([...participants, { name, id: Date.now() }]);
        setNewParticipant({ name: '' });
      };
      const deleteParticipant = (id) => {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞?')) return;
        setParticipants(prev => prev.filter(p => p.id !== id));
        // –æ—á–∏—â–∞–µ–º –µ–≥–æ –¥–æ–ª–∏
        setConsumption(prev => {
          const next = {...prev};
          Object.keys(next).forEach(k => { if (next[k]) delete next[k][id]; });
          return next;
        });
      };
      const startEditParticipant = (p) => setEditingParticipant({ id: p.id, name: p.name });
      const saveEditParticipant = () => {
        if (editingParticipant && editingParticipant.name.trim()) {
          setParticipants(participants.map(p => p.id === editingParticipant.id ? { ...p, name: editingParticipant.name.trim() } : p));
          setEditingParticipant(null);
        }
      };

      /* --------- –ü–æ–∫—É–ø–∫–∏ --------- */
      const addPurchase = () => {
        const {product, price, quantity, buyer} = newPurchase;
        if (!product || !price || !quantity || !buyer) return;
        setPurchases([...purchases, { id: Date.now(), product, price: parseFloat(price)||0, quantity: parseFloat(quantity)||0, buyer }]);
        setNewPurchase({ product: '', price: '', quantity: '', buyer: '' });
      };
      const deletePurchase = (id) => {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–∫—É–ø–∫—É?')) return;
        setPurchases(prev => prev.filter(p => p.id !== id));
        // –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏–º –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º, —Ç–∞–∫ —á—Ç–æ –∑–¥–µ—Å—å –Ω–∏—á–µ–≥–æ —á–∏—Å—Ç–∏—Ç—å –Ω–µ –Ω—É–∂–Ω–æ
      };
      const startEditPurchase = (p) => setEditingPurchase({ ...p });
      const saveEditPurchase = () => {
        if (!editingPurchase) return;
        setPurchases(purchases.map(p => p.id === editingPurchase.id ? ({...editingPurchase, price:parseFloat(editingPurchase.price)||0, quantity:parseFloat(editingPurchase.quantity)||0}) : p));
        setEditingPurchase(null);
      };

      /* --------- –ì—Ä—É–ø–ø—ã –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º --------- */
      const groupPurchases = () => {
        const groups = {};
        purchases.forEach(p => {
          const key = p.product.trim() || `id:${p.id}`;
          if (!groups[key]) groups[key] = { product: p.product, key, items: [], totalQuantity:0, totalPrice:0 };
          groups[key].items.push(p);
          groups[key].totalQuantity += (parseFloat(p.quantity)||0);
          groups[key].totalPrice   += (parseFloat(p.price)||0) * (parseFloat(p.quantity)||0);
        });
        return Object.values(groups);
      };

      /* --------- –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ (–≤–≤–æ–¥ –¥–æ–ª–µ–π –ø–æ –ø—Ä–æ–¥—É–∫—Ç—É) --------- */
      const updateConsumption = (groupKey, participantId, value) => {
        setConsumption(prev => ({
          ...prev,
          [groupKey]: { ...(prev[groupKey]||{}), [participantId]: value === '' ? 0 : (parseFloat(value)||0) }
        }));
      };
      const quickSet = (groupKey, participantId, option, totalQuantity) => {
        let value = 0;
        if (option === '0') value = 0;
        else if (option === 'all') value = totalQuantity;
        else if (option.includes('/')) value = totalQuantity / parseInt(option.split('/')[1]);
        updateConsumption(groupKey, participantId, value.toString());
      };
      const distributeEvenly = (groupKey, totalQuantity) => {
        const cnt = Math.max(1, participants.length);
        const per = totalQuantity / cnt;
        setConsumption(prev => ({
          ...prev,
          [groupKey]: Object.fromEntries(participants.map(p => [p.id, per]))
        }));
      };

      /* --------- –†–∞—Å—á—ë—Ç—ã –ø–µ—Ä–µ–≤–æ–¥–æ–≤ --------- */
      const calculateSettlements = () => {
        // 1) –ë–∞–ª–∞–Ω—Å—ã: –∫—Ç–æ —Å–∫–æ–ª—å–∫–æ –ø–æ—Ç—Ä–∞—Ç–∏–ª
        const balances = {};
        participants.forEach(p => { balances[p.id] = { name: p.name, spent: 0, owes: 0 }; });
        purchases.forEach(p => {
          const buyerId = participants.find(x => x.name === p.buyer)?.id;
          if (buyerId) balances[buyerId].spent += (p.price||0)*(p.quantity||0);
        });
        // 2) –î–æ–ª–≥–∏ –ø–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—é (–ø–æ –≥—Ä—É–ø–ø–∞–º, —Ü–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è)
        groupPurchases().forEach(g => {
          const consumed = consumption[g.key] || {};
          const totalConsumed = Object.values(consumed).reduce((s,v)=>s+(v||0),0);
          if (g.totalQuantity > 0 && totalConsumed > 0) {
            const pricePerUnit = g.totalPrice / g.totalQuantity; // —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É –ø—Ä–æ–¥—É–∫—Ç–∞
            Object.entries(consumed).forEach(([pid, qty]) => {
              if ((qty||0) > 0 && balances[pid]) balances[pid].owes += (qty||0) * pricePerUnit;
            });
          }
        });
        // 3) –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã
        const creditors = [], debtors = [];
        Object.entries(balances).forEach(([id, d]) => {
          const bal = d.spent - d.owes;
          if (bal > 0.01) creditors.push({ id, name: d.name, amount: bal });
          if (bal < -0.01) debtors.push({ id, name: d.name, amount: -bal });
        });
        const transfers = []; let i=0, j=0;
        while (i < debtors.length && j < creditors.length) {
          const amount = Math.min(debtors[i].amount, creditors[j].amount);
          if (amount > 0.01) transfers.push({ from: debtors[i].name, fromId: debtors[i].id, to: creditors[j].name, toId: creditors[j].id, amount: Math.round(amount*100)/100 });
          debtors[i].amount -= amount; creditors[j].amount -= amount;
          if (debtors[i].amount < 0.01) i++; if (creditors[j].amount < 0.01) j++;
        }
        setSettlements(transfers);
      };

      const handleSBPPayment = (transfer) => {
        try {
          window.Telegram?.WebApp?.showAlert?.(
            `–î–ª—è –æ–ø–ª–∞—Ç—ã ${transfer.amount}‚ÇΩ:

1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–∞–Ω–∫–æ–≤—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –í—ã–±–µ—Ä–∏—Ç–µ ¬´–ü–µ—Ä–µ–≤–æ–¥ –ø–æ –°–ë–ü¬ª
3. –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É ${transfer.amount}‚ÇΩ`,
            () => setPaymentStatuses(prev => ({ ...prev, [`${transfer.fromId}-${transfer.toId}`]: 'pending' }))
          );
        } catch(_) {
          alert(`–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ ${transfer.amount}‚ÇΩ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${transfer.to}`);
          setPaymentStatuses(prev => ({ ...prev, [`${transfer.fromId}-${transfer.toId}`]: 'pending' }));
        }
      };

      /* --------- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ --------- */
      const fairDistribution = (()=>{
        try{
          const result = {};
          groupPurchases().forEach(g => {
            if (g.totalQuantity>0) {
              const pricePerUnit = g.totalPrice / g.totalQuantity;
              const consumed = consumption[g.key] || {};
              Object.entries(consumed).forEach(([pid, qty]) => {
                if ((qty||0)>0){
                  const name = participants.find(p=>p.id==pid)?.name;
                  if (name){ result[name] = (result[name]||0) + qty*pricePerUnit; }
                }
              });
            }
          });
          return result;
        }catch(e){ console.warn('fairDistribution error', e); return {}; }
      })();
      const topExpenses = (()=>{
        try{
          const totals = {};
          purchases.forEach(p => {
            totals[p.product] = (totals[p.product]||0) + (p.price||0)*(p.quantity||0);
          });
          return Object.entries(totals).sort(([,a],[,b])=>b-a).slice(0,3);
        }catch(e){ return []; }
      })();

      const tabs = [
        { id: 'participants', label: '–£—á–∞—Å—Ç–Ω–∏–∫–∏', icon: Users },
        { id: 'purchases', label: '–ü–æ–∫—É–ø–∫–∏', icon: ShoppingCart },
        { id: 'consumption', label: '–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ', icon: Calculator },
        { id: 'settlement', label: '–†–∞—Å—á—ë—Ç—ã', icon: TrendingUp }
      ];

      /* --------- –≠–∫—Ä–∞–Ω—ã --------- */
      if (screen === 'splash') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 flex items-center justify-center p-4">
            <div className="text-center">
              <div className="mb-8 animate-bounce text-8xl">üéâ</div>
              <h1 className="text-5xl font-bold text-white mb-4">Party Calculator</h1>
              <p className="text-xl text-white/90">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–∞—Å—Ö–æ–¥–æ–≤</p>
            </div>
          </div>
        );
      }

      if (screen === 'main') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
            <div className="max-w-md mx-auto mt-20">
              <div className="bg-white rounded-3xl shadow-2xl p-8">
                <div className="text-center mb-8">
                  <div className="text-6xl mb-4">üéâ</div>
                  <h1 className="text-3xl font-bold text-gray-800 mb-2">Party Calculator</h1>
                  <p className="text-gray-600">–ß–µ—Å—Ç–Ω—ã–π —Ä–∞—Å—á—ë—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</p>
                </div>
                <input
                  type="text"
                  placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è"
                  value={eventName}
                  onChange={(e) => setEventName(e.target.value)}
                  onKeyDown={(e) => { if (e.key === 'Enter' && eventName.trim()) setScreen('tabs'); }}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none mb-4"
                />
                <button
                  onClick={() => eventName.trim() && setScreen('tabs')}
                  className="w-full bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 font-semibold"
                >–°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50">
          <div className="bg-white border-b sticky top-0 z-10">
            <div className="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
              <h1 className="text-xl font-bold text-gray-800">{eventName || '–ú–æ—ë –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ'}</h1>
              <div className="flex gap-2">
                <button onClick={() => setShowHelp(true)} className="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg"><Info className="w-5 h-5" /></button>
                <button onClick={() => setShowResetConfirm(true)} className="p-2 text-red-600 hover:bg-red-50 rounded-lg"><RotateCcw className="w-5 h-5" /></button>
              </div>
            </div>
            <div className="max-w-4xl mx-auto px-2 flex overflow-x-auto">
              {tabs.map((t) => { const T = t.icon; return (
                <button key={t.id} onClick={() => setActiveTab(t.id)} className={`flex-1 px-4 py-3 flex items-center justify-center gap-2 border-b-2 transition ${activeTab === t.id ? 'text-indigo-600 border-indigo-600 bg-indigo-50' : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50 border-transparent'}`}>
                  <T className="w-4 h-4" />{t.label}
                </button>
              );})}
            </div>
          </div>

          <div className="max-w-4xl mx-auto p-4 pb-20">
            {activeTab === 'participants' && (
              <div>
                <div className="space-y-2 mb-4">
                  <input type="text" placeholder="–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞" value={newParticipant.name} onChange={(e) => setNewParticipant({name: e.target.value})} onKeyDown={(e)=>{ if(e.key==='Enter') addParticipant(); }} className="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none" />
                  <button onClick={addParticipant} className="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2"><Plus className="w-5 h-5"/>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</button>
                </div>
                <div className="space-y-2">
                  {participants.map((p) => (
                    <div key={p.id} className="bg-white px-4 py-3 rounded-lg shadow-sm">
                      {editingParticipant?.id === p.id ? (
                        <div className="flex gap-2">
                          <input type="text" value={editingParticipant.name} onChange={(e)=>setEditingParticipant({...editingParticipant, name:e.target.value})} className="flex-1 px-2 py-1 border border-gray-300 rounded" />
                          <button onClick={saveEditParticipant} className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">‚úì</button>
                          <button onClick={() => setEditingParticipant(null)} className="px-3 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‚úï</button>
                        </div>
                      ) : (
                        <div className="flex items-center justify-between">
                          <span className="font-medium text-gray-800 truncate">{p.name}</span>
                          <div className="flex gap-2">
                            <button onClick={() => startEditParticipant(p)} className="p-1 text-blue-600 hover:bg-blue-50 rounded"><Edit2 className="w-4 h-4"/></button>
                            <button onClick={() => deleteParticipant(p.id)} className="p-1 text-red-600 hover:bg-red-50 rounded"><Trash2 className="w-4 h-4"/></button>
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {activeTab === 'purchases' && (
              <div>
                {participants.length < 1 ? (
                  <div className="text-center py-8 text-gray-500"><Users className="w-12 h-12 mx-auto mb-2 text-gray-400"/><p>–î–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p></div>
                ) : (
                  <div>
                    <div className="bg-white p-4 rounded-lg shadow-sm mb-4">
                      <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞" value={newPurchase.product} onChange={(e)=>setNewPurchase({...newPurchase, product:e.target.value})} className="w-full px-4 py-2 mb-2 border border-gray-300 rounded-lg" />
                      <div className="grid grid-cols-2 gap-2 mb-2">
                        <input type="number" step="0.01" placeholder="–¶–µ–Ω–∞ –∑–∞ —à—Ç" value={newPurchase.price} onChange={(e)=>setNewPurchase({...newPurchase, price:e.target.value})} className="px-4 py-2 border border-gray-300 rounded-lg" />
                        <input type="number" step="0.01" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" value={newPurchase.quantity} onChange={(e)=>setNewPurchase({...newPurchase, quantity:e.target.value})} className="px-4 py-2 border border-gray-300 rounded-lg" />
                      </div>
                      <select value={newPurchase.buyer} onChange={(e)=>setNewPurchase({...newPurchase, buyer:e.target.value})} className="w-full px-4 py-2 mb-2 border border-gray-300 rounded-lg">
                        <option value="">–ö—Ç–æ –∫—É–ø–∏–ª?</option>
                        {participants.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}
                      </select>
                      <button onClick={addPurchase} className="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2"><Plus className="w-5 h-5"/>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∫—É–ø–∫—É</button>
                    </div>
                    <div className="space-y-2">
                      {purchases.map((p) => (
                        <div key={p.id} className="bg-white px-4 py-3 rounded-lg shadow-sm">
                          {editingPurchase?.id === p.id ? (
                            <div className="space-y-2">
                              <input type="text" value={editingPurchase.product} onChange={(e)=>setEditingPurchase({...editingPurchase, product:e.target.value})} className="w-full px-2 py-1 border border-gray-300 rounded" />
                              <div className="grid grid-cols-2 gap-2">
                                <input type="number" step="0.01" value={editingPurchase.price} onChange={(e)=>setEditingPurchase({...editingPurchase, price:e.target.value})} className="px-2 py-1 border border-gray-300 rounded" />
                                <input type="number" step="0.01" value={editingPurchase.quantity} onChange={(e)=>setEditingPurchase({...editingPurchase, quantity:e.target.value})} className="px-2 py-1 border border-gray-300 rounded" />
                              </div>
                              <div className="flex gap-2">
                                <button onClick={saveEditPurchase} className="flex-1 px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <button onClick={() => setEditingPurchase(null)} className="flex-1 px-3 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">–û—Ç–º–µ–Ω–∞</button>
                              </div>
                            </div>
                          ) : (
                            <div>
                              <div className="flex items-center justify-between mb-1">
                                <span className="font-medium text-gray-800">{p.product}</span>
                                <div className="flex gap-2">
                                  <button onClick={() => startEditPurchase(p)} className="p-1 text-blue-600 hover:bg-blue-50 rounded"><Edit2 className="w-4 h-4"/></button>
                                  <button onClick={() => deletePurchase(p.id)} className="p-1 text-red-600 hover:bg-red-50 rounded"><Trash2 className="w-4 h-4"/></button>
                                </div>
                              </div>
                              <div className="text-sm text-gray-600">{p.price}‚ÇΩ √ó {p.quantity} = {((p.price||0)*(p.quantity||0)).toFixed(2)}‚ÇΩ</div>
                              <div className="text-xs text-gray-500">–ö—É–ø–∏–ª: {p.buyer}</div>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            {activeTab === 'consumption' && (
              <div>
                {purchases.length === 0 ? (
                  <div className="text-center py-8 text-gray-500"><ShoppingCart className="w-12 h-12 mx-auto mb-2 text-gray-400"/><p>–î–æ–±–∞–≤—å—Ç–µ –ø–æ–∫—É–ø–∫–∏</p></div>
                ) : (
                  <div>
                    <div className="overflow-x-auto mb-6">
                      <table className="w-full">
                        <thead>
                          <tr className="bg-gray-100">
                            <th className="p-2 text-left text-sm font-semibold">–ü—Ä–æ–¥—É–∫—Ç</th>
                            {participants.map(p => <th key={p.id} className="p-2 text-center text-sm font-semibold">{p.name}</th>)}
                          </tr>
                        </thead>
                        <tbody>
                          {groupPurchases().map(group => {
                            const consumed = consumption[group.key] || {};
                            const totalConsumed = Object.values(consumed).reduce((s,v)=>s+(v||0),0);
                            const status = Math.abs((group.totalQuantity||0) - totalConsumed) < 0.01 ? 'balanced' : (totalConsumed < (group.totalQuantity||0) ? 'under' : 'over');
                            return (
                              <tr key={group.key} className={`border-b ${status === 'balanced' ? 'bg-green-50' : status === 'under' ? 'bg-yellow-50' : 'bg-red-50'}`}>
                                <td className="p-2 font-medium">
                                  {group.product || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}
                                  <div className="text-xs text-gray-500">–í—Å–µ–≥–æ: {Number(group.totalQuantity||0).toFixed(2)}</div>
                                  <button onClick={() => distributeEvenly(group.key, group.totalQuantity||0)} className="text-xs text-indigo-600 hover:underline mt-1">‚ö° –ü–æ—Ä–æ–≤–Ω—É –Ω–∞ –≤—Å–µ—Ö</button>
                                </td>
                                {participants.map(p => {
                                  const value = consumption[group.key]?.[p.id] || 0;
                                  return (
                                    <td key={p.id} className="p-2">
                                      <div className="flex flex-col gap-1 items-center">
                                        <input type="number" step="0.01" placeholder="0" value={value>0?String(value):''} onChange={(e)=>updateConsumption(group.key, p.id, e.target.value)} className="w-20 px-2 py-1 border border-gray-300 rounded text-center" />
                                        <select onChange={(e)=>{ if(e.target.value){ quickSet(group.key, p.id, e.target.value, group.totalQuantity||0); e.target.value=''; }}} className="w-20 px-1 py-1 text-xs border border-gray-300 rounded">
                                          <option value="">–î–æ–ª—è</option>
                                          <option value="0">–ù–µ –µ–ª</option>
                                          {Array.from({ length: Math.max(1, participants.length) }, (_, i) => Math.max(1, participants.length) - i).map(d => <option key={d} value={`1/${d}`}>1/{d}</option>)}
                                          <option value="all">–í—Å—ë</option>
                                        </select>
                                      </div>
                                    </td>
                                  );
                                })}
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>

                    {Object.keys(fairDistribution).length > 0 && (
                      <div className="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4 mb-4">
                        <div className="flex items-center gap-2 mb-3"><span className="text-2xl">üéØ</span><h3 className="font-bold text-gray-800">–ß–µ—Å—Ç–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</h3></div>
                        <div className="space-y-2">
                          {Object.entries(fairDistribution).sort(([,a],[,b])=>b-a).map(([name, amount]) => (
                            <div key={name} className="flex justify-between items-center"><span className="font-medium">‚Ä¢ {name}</span><span className="font-bold text-gray-800">{amount.toFixed(2)}‚ÇΩ</span></div>
                          ))}
                        </div>
                      </div>
                    )}

                    <div className="bg-blue-50 border-2 border-blue-300 rounded-xl p-4">
                      <div className="flex items-center gap-2 mb-3"><span className="text-2xl">üì¶</span><h3 className="font-bold text-gray-800">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∫—É–ø–æ–∫</h3></div>
                      {groupPurchases().map((group, idx) => (
                        <div key={group.key} className="mb-3">
                          <div className="font-bold text-gray-800 mb-1">{idx + 1}. {group.product || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                          {group.items.map((item, itemIdx) => (
                            <div key={item.id} className="text-sm text-gray-600 ml-4">–ü–æ–∫—É–ø–∫–∞ #{itemIdx + 1}: {item.price}‚ÇΩ √ó {item.quantity} = {((item.price||0)*(item.quantity||0)).toFixed(2)}‚ÇΩ (–ø–æ–∫—É–ø–∞—Ç–µ–ª—å: {item.buyer})</div>
                          ))}
                          <div className="text-sm font-bold text-indigo-600 ml-4 mt-1">–ò—Ç–æ–≥–æ –ø–æ –ø—Ä–æ–¥—É–∫—Ç—É: {(group.totalPrice||0).toFixed(2)}‚ÇΩ</div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            {activeTab === 'settlement' && (
              <div>
                {purchases.length === 0 ? (
                  <div className="text-center py-8 text-gray-500"><Calculator className="w-12 h-12 mx-auto mb-2 text-gray-400"/><p>–î–æ–±–∞–≤—å—Ç–µ –ø–æ–∫—É–ø–∫–∏</p></div>
                ) : settlements.length === 0 ? (
                  <div className="text-center py-8"><button onClick={calculateSettlements} className="bg-indigo-600 text-white px-8 py-3 rounded-xl hover:bg-indigo-700 font-semibold">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã</button></div>
                ) : (
                  <div>
                    <div className="mb-6">
                      <div className="flex items-center gap-2 mb-3"><span className="text-2xl">üí∞</span><h3 className="font-bold text-gray-800 text-lg">–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</h3></div>
                      <div className="grid grid-cols-2 gap-3">
                        <div className="col-span-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white p-4 rounded-xl shadow-lg">
                          <div className="text-sm opacity-90 mb-1">–í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
                          <div className="text-3xl font-bold">{purchases.reduce((s,p)=>s+(p.price||0)*(p.quantity||0),0).toFixed(2)}‚ÇΩ</div>
                        </div>
                        {topExpenses.map(([product, amount], idx) => {
                          const colors = ['from-pink-500 to-rose-500', 'from-blue-500 to-cyan-500', 'from-orange-500 to-amber-500'];
                          return (
                            <div key={product} className={`bg-gradient-to-br ${colors[idx]} text-white p-4 rounded-xl shadow-lg`}>
                              <div className="text-xs opacity-90 mb-1 truncate">{product || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                              <div className="text-2xl font-bold">{amount.toFixed(2)}‚ÇΩ</div>
                            </div>
                          );
                        })}
                      </div>
                    </div>

                    <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2"><span className="text-2xl">üéØ</span>–ò—Ç–æ–≥–æ–≤—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã</h3>
                    <div className="space-y-3">
                      {settlements.map((t, i) => {
                        const statusKey = `${t.fromId}-${t.toId}`;
                        const status = paymentStatuses[statusKey] || 'unpaid';
                        return (
                          <div key={i} className={`p-4 rounded-xl border-2 ${status === 'paid' ? 'bg-green-50 border-green-300' : status === 'pending' ? 'bg-blue-50 border-blue-300' : 'bg-red-50 border-red-300'}`}>
                            <div className="flex items-center justify-between mb-3">
                              <div className="flex-1">
                                <div className="font-bold text-gray-800 mb-1">{t.from} ‚Üí {t.to}</div>
                                <div className="text-2xl font-bold text-indigo-600">{t.amount.toFixed(2)}‚ÇΩ</div>
                              </div>
                              {status === 'paid' ? <CheckCircle className="w-8 h-8 text-green-600" /> : status === 'pending' ? <Clock className="w-8 h-8 text-blue-600" /> : <XCircle className="w-8 h-8 text-red-600" />}
                            </div>

                            {status === 'unpaid' && (
                              <button onClick={() => handleSBPPayment(t)} className="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 font-semibold">–û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ –°–ë–ü</button>
                            )}
                            {status === 'pending' && (
                              <div className="flex gap-2">
                                <button onClick={() => setPaymentStatuses(prev => ({ ...prev, [statusKey]: 'paid' }))} className="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 font-semibold flex items-center justify-center gap-1"><CheckCircle className="w-4 h-4"/>–£–∂–µ –æ–ø–ª–∞—Ç–∏–ª</button>
                                <button onClick={() => setPaymentStatuses(prev => ({ ...prev, [statusKey]: 'unpaid' }))} className="flex-1 bg-gray-400 text-white py-2 rounded-lg hover:bg-gray-500 font-semibold">–û—Ç–º–µ–Ω–∞</button>
                              </div>
                            )}
                            {status === 'paid' && (<div className="text-center text-green-700 font-semibold flex items-center justify-center gap-1"><CheckCircle className="w-4 h-4"/>–û–ø–ª–∞—á–µ–Ω–æ</div>)}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>

          {showHelp && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
                <div className="flex items-center justify-between mb-4"><h3 className="text-2xl font-bold text-gray-800">–ü–æ–º–æ—â—å</h3><button onClick={()=>setShowHelp(false)} className="text-gray-500 hover:text-gray-700">‚úï</button></div>
                <div className="space-y-4 text-sm">
                  <div>
                    <h4 className="font-bold text-gray-800 mb-2">üìù –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</h4>
                    <ol className="list-decimal list-inside space-y-1 text-gray-600">
                      <li>–î–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</li>
                      <li>–í–Ω–µ—Å–∏—Ç–µ –ø–æ–∫—É–ø–∫–∏</li>
                      <li>–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–æ —Ç–æ–≤–∞—Ä–∞–º</li>
                      <li>–ù–∞–∂–º–∏—Ç–µ ¬´–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã¬ª</li>
                    </ol>
                  </div>
                  <div className="pt-4 border-t border-gray-200 text-center">
                    <p className="text-gray-600 mb-2">–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: –í–ª–∞–¥–∏–º–∏—Ä –í–∞—Å—è–∫–∏–Ω</p>
                    <button onClick={()=>{
                      try{ window.location.href = 'mailto:e@mailvladimir.ru?subject=Party Calculator - –≤–æ–ø—Ä–æ—Å'; }
                      catch(e){ navigator.clipboard?.writeText('e@mailvladimir.ru').then(()=>alert('–ü–æ—á—Ç–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞: e@mailvladimir.ru')); }
                    }} className="text-indigo-600 hover:text-indigo-700 flex items-center justify-center gap-1 mx-auto">
                      <Copy className="w-4 h-4" /> e@mailvladimir.ru
                    </button>
                  </div>
                </div>
                <button onClick={()=>setShowHelp(false)} className="w-full mt-6 bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">–ü–æ–Ω—è—Ç–Ω–æ</button>
              </div>
            </div>
          )}

          {showResetConfirm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 max-w-sm w-full">
                <h3 className="text-xl font-bold text-gray-800 mb-2">–¢–æ—á–Ω–æ –≤—Å—ë —Å–±—Ä–æ—Å–∏—Ç—å?</h3>
                <p className="text-gray-600 mb-6">–í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã</p>
                <div className="flex gap-3">
                  <button onClick={()=>setShowResetConfirm(false)} className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300">–û—Ç–º–µ–Ω–∞</button>
                  <button onClick={()=>{ setScreen('main'); setEventName(''); setParticipants([]); setPurchases([]); setConsumption({}); setSettlements([]); setPaymentStatuses({}); setShowResetConfirm(false); }} className="flex-1 bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700">–î–∞, —Å–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(
      <ErrorBoundary>
        <PartyCalculator />
      </ErrorBoundary>,
      document.getElementById('root')
    );
  </script>
</body>
</html>
